{% extends "base.html" %}
{% block title %}Профиль — Drivee{% endblock %}

{% block content %}
<style>
  .profile-page {
    display: grid;
    gap: 24px;
    margin-bottom: 60px;
  }
  .profile-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 24px;
  }
  .profile-card,
  .section-card {
    background: #fff;
    border-radius: 24px;
    padding: 24px;
    box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
  }
  .profile-head {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
  }
  .avatar-circle {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: #2563eb;
    color: #fff;
    font-weight: 700;
    font-size: 1.6rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .profile-fields {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 18px;
  }
  .profile-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .profile-field label {
    font-size: 0.78rem;
    letter-spacing: 0.05em;
    color: #94a3b8;
    text-transform: uppercase;
  }
  .profile-field input,
  .profile-field .readonly-field {
    border-radius: 12px;
    border: 1px solid #cbd5f5;
    padding: 10px 12px;
    font-weight: 600;
    color: #0f172a;
  }
  .readonly-field {
    background: #f8fafc;
  }
  .profile-info-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .profile-info-form button {
    align-self: flex-start;
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    background: #2563eb;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
  }
  .field-errors {
    font-size: 0.8rem;
    color: #dc2626;
  }
  .section-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .vehicle-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
  }
  .vehicle-item {
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 14px 16px;
    display: flex;
    justify-content: space-between;
    gap: 16px;
    flex-wrap: wrap;
  }
  .vehicle-meta {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .vehicle-meta strong {
    font-size: 1rem;
  }
  .vehicle-meta span {
    font-size: 0.9rem;
    color: #475569;
  }
  .vehicle-item form button {
    background: transparent;
    border: none;
    color: #ef4444;
    font-weight: 600;
    cursor: pointer;
  }
  .vehicle-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    align-items: end;
  }
  .vehicle-form label {
    display: block;
    font-size: 0.85rem;
    margin-bottom: 6px;
    color: #475569;
  }
  .vehicle-form input,
  .vehicle-form select {
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid #cbd5f5;
  }
  .vehicle-form button {
    border: none;
    border-radius: 12px;
    padding: 12px;
    background: #2563eb;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
  }
  .orders-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .order-card {
    border: 1px solid #e2e8f0;
    border-radius: 20px;
    padding: 18px;
  }
  .order-head {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }
  .order-head span {
    font-size: 0.9rem;
    color: #94a3b8;
  }
  .order-status {
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
  }
  .order-status.new { background: #eff6ff; color: #1d4ed8; }
  .order-status.confirmed { background: #ecfccb; color: #15803d; }
  .order-status.declined { background: #fee2e2; color: #b91c1c; }
   .order-status.cancelled { background: #f1f5f9; color: #475569; }
  .order-cancel-btn {
    margin-top: 12px;
    padding: 10px 14px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    background: #f8fafc;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.1s ease, background 0.2s;
  }
  .order-cancel-btn:hover { background:#f1f5f9; }
  .order-cancel-btn:active { transform: translateY(1px); }
  .order-items {
    margin: 16px 0;
    border-top: 1px solid #e2e8f0;
    border-bottom: 1px solid #e2e8f0;
    padding: 12px 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .order-item {
    display: flex;
    justify-content: space-between;
    font-size: 0.95rem;
  }
  .empty-state {
    padding: 16px;
    border-radius: 16px;
    border: 1px dashed #cbd5f5;
    color: #64748b;
    text-align: center;
  }
  .logout-btn {
    width: 100%;
    margin-top: 20px;
    border: none;
    border-radius: 12px;
    background: #ef4444;
    color: #fff;
    padding: 12px;
    font-weight: 600;
    cursor: pointer;
  }
  .logout-btn:hover {
    background: #dc2626;
  }
</style>

<div class="profile-page">
  <div class="profile-grid">
    <div class="profile-card">
      <div class="profile-head">
        <div class="avatar-circle">
          {{ user.full_name|default:user.email|slice:":1"|upper }}
        </div>
        <div>
          <h1 style="margin:0;">{{ user.full_name|default:user.email }}</h1>
          <p style="color:#64748b;margin:6px 0 0;">С нами с {{ user.date_joined|date:"d.m.Y" }}</p>
        </div>
      </div>
      <form method="post" class="profile-info-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_profile">
        <div class="profile-fields">
          <div class="profile-field">
            <label>{{ profile_form.full_name.label }}</label>
            {{ profile_form.full_name }}
            {% if profile_form.full_name.errors %}
              <div class="field-errors">{{ profile_form.full_name.errors|join:", " }}</div>
            {% endif %}
          </div>
          <div class="profile-field">
            <label>{{ profile_form.email.label }}</label>
            {{ profile_form.email }}
            {% if profile_form.email.errors %}
              <div class="field-errors">{{ profile_form.email.errors|join:", " }}</div>
            {% endif %}
          </div>
          <div class="profile-field">
            <label>{{ profile_form.phone_number.label }}</label>
            {{ profile_form.phone_number }}
            {% if profile_form.phone_number.errors %}
              <div class="field-errors">{{ profile_form.phone_number.errors|join:", " }}</div>
            {% endif %}
          </div>
          <div class="profile-field">
            <label>{{ profile_form.date_of_birth.label }}</label>
            {{ profile_form.date_of_birth }}
            {% if profile_form.date_of_birth.errors %}
              <div class="field-errors">{{ profile_form.date_of_birth.errors|join:", " }}</div>
            {% endif %}
          </div>
        </div>
        <button type="submit">Сохранить изменения</button>
      </form>
      <form action="{% url 'logout' %}" method="post">
        {% csrf_token %}
        <button class="logout-btn">Выйти</button>
      </form>
    </div>

    <div class="section-card">
      <div class="section-title">
        Мои автомобили
      </div>
      {% if vehicles %}
        <div class="vehicle-list">
          {% for vehicle in vehicles %}
            <div class="vehicle-item">
              <div class="vehicle-meta">
                <strong>{{ vehicle.car.make }} {{ vehicle.car.model }} {{ vehicle.car.generation }}</strong>
                <span>VIN: {{ vehicle.vin|default:"—" }}</span>
                <span>Госномер: {{ vehicle.license_plate|default:"—" }}</span>
              </div>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_vehicle">
                <input type="hidden" name="vehicle_id" value="{{ vehicle.id }}">
                <button type="submit">Удалить</button>
              </form>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">Добавьте свой автомобиль, чтобы получать рекомендации по совместимым товарам.</div>
      {% endif %}

      <form method="post" class="vehicle-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_vehicle">
        <div>
          <label>{{ vehicle_form.car.label }}</label>
          {{ vehicle_form.car }}
          {{ vehicle_form.car.errors }}
        </div>
        <div>
          <label>{{ vehicle_form.vin.label }}</label>
          {{ vehicle_form.vin }}
          {{ vehicle_form.vin.errors }}
        </div>
        <div>
          <label>{{ vehicle_form.license_plate.label }}</label>
          {{ vehicle_form.license_plate }}
          {{ vehicle_form.license_plate.errors }}
        </div>
        <button type="submit">Добавить авто</button>
      </form>
    </div>
  </div>

  <div class="section-card">
    <div class="section-title">История заказов</div>
    {% if orders %}
      <div class="orders-list">
        {% for order in orders %}
          <div class="order-card">
              {% with status=order.status|default:"new"|lower %}
              <div class="order-head">
                <div>
                  <strong>Заказ #{{ order.id }}</strong>
                  <span>{{ order.created_at|date:"d.m.Y H:i" }}</span>
                </div>
                <span class="order-status {{ status }}">
                  {% if status == "new" %}
                    Новый
                  {% elif status == "confirmed" %}
                    Подтверждён
                  {% elif status == "declined" %}
                    Отклонён
                  {% elif status == "cancelled" %}
                    Отменён
                  {% else %}
                    {{ status|capfirst }}
                  {% endif %}
                </span>
              </div>
              {% endwith %}
            <div class="order-items">
              {% for item in order.cart_snapshot %}
                <div class="order-item">
                  <span>{{ item.name }} · {{ item.quantity }} шт.</span>
                  <span>{{ item.line_total }} ₽</span>
                </div>
              {% endfor %}
            </div>
            <p style="margin:0 0 8px;color:#475569;">
              Доставка: {{ order.get_delivery_type_display }}{% if order.pickup_point %} — {{ order.pickup_point.name }}{% endif %}<br>
              Оплата: {{ order.get_payment_method_display }}
            </p>
            {% if order.comment %}
              <p style="margin:0 0 8px;color:#94a3b8;">Комментарий: {{ order.comment }}</p>
            {% endif %}
            <strong>Итого: {{ order.total_amount }} ₽</strong>
            {% if order.status|lower != "cancelled" and order.status|lower != "declined" %}
              <form method="post" action="{% url 'cancel_order' order.id %}" style="margin-top:10px;">
                {% csrf_token %}
                <button type="submit" class="order-cancel-btn">Отменить заказ</button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">Вы ещё не оформляли заказы.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
