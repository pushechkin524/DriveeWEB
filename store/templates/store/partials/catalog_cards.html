{% for product in products %}
  <div class="product-card">
    <div style="position:relative;">
      <a href="{% url 'product_detail' product.id %}" class="product-link">
      {% if product.image %}
        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-img" loading="lazy">
      {% else %}
        <div class="product-img product-img--placeholder">
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="8" y="18" width="48" height="34" rx="4" stroke="currentColor" stroke-width="2"/>
            <path d="M20 26L24 20H40L44 26" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="32" cy="37" r="10" stroke="currentColor" stroke-width="2"/>
            <circle cx="32" cy="37" r="4" fill="currentColor"/>
          </svg>
          <span>–ù–µ—Ç —Ñ–æ—Ç–æ</span>
        </div>
      {% endif %}
      </a>
      <form method="post" action="{% url 'toggle_favorite' product.id %}" style="position:absolute; top:10px; right:10px;">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path }}">
        <button type="submit" class="favorite-btn" aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
          {% if favorites_ids and product.id in favorites_ids %}
            ‚ù§Ô∏è
          {% else %}
            ü§ç
          {% endif %}
        </button>
      </form>
    </div>
    <div class="product-info">
        {% if product.brand %}
          <div class="product-brand"><a href="{% url 'brand_detail' product.brand_id %}">{{ product.brand.name }}</a></div>
        {% endif %}
        <div class="product-name">{{ product.name }}</div>
        <div class="product-price">{{ product.price }} ‚ÇΩ</div>
        {% with part=product.auto_part_spec goods=product.auto_goods_spec tire=product.tire_spec rim=product.rim_spec battery=product.battery_spec %}
          {% if part or goods or tire or rim or battery %}
            <div class="product-specs">
              {% if tire %}
                <div><strong>–°–µ–∑–æ–Ω:</strong> {{ tire.get_season_display }}</div>
                <div><strong>–†–∞–∑–º–µ—Ä:</strong> {{ tire.width }}/{{ tire.profile }} {{ tire.diameter }}</div>
                {% if tire.stud_type %}<div><strong>–¢–∏–ø:</strong> {{ tire.get_stud_type_display }}</div>{% endif %}
              {% elif rim %}
                <div><strong>–î–∏–∞–º–µ—Ç—Ä:</strong> {{ rim.diameter }}</div>
                <div><strong>–®–∏—Ä–∏–Ω–∞:</strong> {{ rim.width }}</div>
                {% if rim.pcd %}<div><strong>PCD:</strong> {{ rim.pcd }}</div>{% endif %}
                {% if rim.offset %}<div><strong>ET:</strong> {{ rim.offset }}</div>{% endif %}
              {% elif battery %}
                <div><strong>–Å–º–∫–æ—Å—Ç—å:</strong> {{ battery.capacity_ah }}</div>
                <div><strong>–ü—É—Å–∫–æ–≤–æ–π —Ç–æ–∫:</strong> {{ battery.cold_cranking_amps }}</div>
                {% if battery.voltage %}<div><strong>–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ:</strong> {{ battery.voltage }}</div>{% endif %}
              {% elif part %}
                {% if part.oem_number %}<div><strong>OEM:</strong> {{ part.oem_number }}</div>{% endif %}
                {% if part.compatibility %}<div><strong>–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:</strong> {{ part.compatibility }}</div>{% endif %}
                {% if part.country_of_origin %}<div><strong>–°—Ç—Ä–∞–Ω–∞:</strong> {{ part.country_of_origin }}</div>{% endif %}
              {% elif goods %}
                {% if goods.article_code %}<div><strong>–ê—Ä—Ç–∏–∫—É–ª:</strong> {{ goods.article_code }}</div>{% endif %}
                {% if goods.volume_or_weight %}<div><strong>–û–±—ä—ë–º/–í–µ—Å:</strong> {{ goods.volume_or_weight }}</div>{% endif %}
                {% if goods.size %}<div><strong>–†–∞–∑–º–µ—Ä:</strong> {{ goods.size }}</div>{% endif %}
              {% endif %}
            </div>
          {% endif %}
        {% endwith %}
        <div class="product-stock {% if product.stock_quantity <= 0 %}out{% endif %}">
          {% if product.stock_quantity > 0 %}
            –í –Ω–∞–ª–∏—á–∏–∏: {{ product.stock_quantity }} —à—Ç.
          {% else %}
            –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
          {% endif %}
        </div>
    </div>
    <div class="product-actions">
      {% if user.is_authenticated %}
        {% if product.stock_quantity > 0 %}
          <form class="product-form" action="{% url 'add_to_cart' product.id %}" method="post">
            {% csrf_token %}
            <input type="number" name="quantity" min="1" max="{{ product.stock_quantity }}" value="1" aria-label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="product-btn">üõí –î–æ–±–∞–≤–∏—Ç—å</button>
          </form>
        {% else %}
          <button type="button" class="product-btn" disabled>–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</button>
        {% endif %}
      {% else %}
        <a href="{% url 'login' %}?next={% url 'catalog' %}" class="product-btn product-btn--ghost">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å</a>
      {% endif %}
    </div>
  </div>
{% empty %}
  <p>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p>
{% endfor %}
